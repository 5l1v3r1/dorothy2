#!/usr/bin/env ruby

require 'rubygems'
require 'trollop'
#require 'dorothy2'

load '../lib/dorothy2.rb'

include DoroEnv
include Dorothy


opts = Trollop.options do
  banner <<-EOS

	The Dorothy Malware Analysis Framework 2.0

  marco.riccardi@
	www.honeynet.it


	Usage:
	Manager.rb [options]
	where [options] are:
  EOS


  opt :verbose, "Enable verbose mode"
  opt :infoflow, "Print the analysis flow"
  opt :source, "Choose a source (manual|honeypot|ztracker)", :type => :string
  opt :daemon, "Stay in the backround, by constantly pooling datasources"

end

if opts[:infoflow]
  puts "
	The Dorothy Malware Analysis Framework 2.0
	---------------Execution Flow-------------
	#0) Fetch new malwares
	#1) Start VM
	#2) Copy File to VM
	#3) Start Sniffer
	#4) Execute file into VM
	#5) Make screenshop
	#6) Wait X minutes (configure X in the conf file)
	#7) Stop Sniffer
	#8) Download Screenshot and trafficdump
	#9) Try to retreive malware info from VirusTotal
	#10) Insert data to Dorothy-DB
	------------------------------------------
	"
  exit(0)
end

#VARS
VERBOSE = (opts[:verbose] ? true : false)
daemon = (opts[:daemon] ? true : false)

#DEFAULT CONF FILES
conf = '../etc/dorothy.yml'

#LOAD ENV
Util.exists?(conf) ? DoroSettings.load!(conf) : DoroConfig.create

sfile = DoroSettings.env[:home] + '/etc/sources.yml'
sboxfile = DoroSettings.env[:home] + '/etc/sandboxes.yml'

#Logging
logout = (daemon ? DoroSettings.env[:logfile] : STDOUT)
LOGGER = DoroLogger.new(logout, DoroSettings.env[:logage])
LOGGER.sev_threshold = DoroSettings.env[:loglevel]

#INIT DB Connector
Insertdb.connect

if Util.exists?(sfile)
  sources = YAML.load_file(sfile)
else
  puts "[WARNING]".red + " A source file doesn't exist, please crate one in the /etc folder" #TODO ..or specify another one in the args -S
  exit(0)
end

unless Util.exists?(sboxfile)
  puts "[WARNING]".red + " There is no sandbox configured yet. Please do it now"
  DoroConfig.create_sandbox
  DoroConfig.init_sandbox(sboxfile)
end

#Check DB sandbox data
if Insertdb.table_empty?("sandboxes")
  puts "[WARNING]".red + " No sandbox found in Dorothive, the DB will be filled with " + sboxfile
  DoroConfig.init_sandbox(sboxfile)
end

if opts[:source] && !sources.key?(opts[:source])
  puts "[WARNING]".red + " The selected source is not yet configured.\nThe available sources are: "
  puts sources.keys
  exit(0)
end

begin
  Dorothy.start sources[opts[:source]], daemon
rescue => e
  LOGGER.error "Dorothy", "An error occurred: " + $!
  LOGGER.debug "Dorothy", "#{e.inspect} --BACKTRACE:  #{e.backtrace}"
  LOGGER.error "Dorothy", "Dorothy has been stopped"
end

